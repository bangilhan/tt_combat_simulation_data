# 요구사항 명세서

본 문서는 교전 단위 시뮬레이션 및 분석 보고서 시스템의 요구사항을 `index_new_report.html`의 실제 구현을 기반으로 구체화한 것입니다.

## 목차

1. [요구사항 관련](#1-요구사항-관련)
2. [운영/정책 관점](#2-운영정책-관점)
3. [데이터/환경 전제](#3-데이터환경-전제)

---

## 1. 요구사항 관련

### 1.1 본 과제에서 반드시 충족되어야 하는 핵심 목적

본 과제의 핵심 목적은 **의심 매치**에 대해 분석하여 다음 두 가지 시나리오에서 활용하는 것입니다:

#### ① 제재 전: 의심 매치 분석 단계

**목적**: "왜 이 유저를 제재해야 하는가"에 대한 판단 근거 제공

**활용 주체**: 운영팀 (제재 검토)

**주요 기능**:
- 의심 매치를 시뮬레이션하여 교전 상황을 재현
- 해당 유저의 탐지 내역들을 종합하여 제공
  - EAC, NCGuard, 사내 ML 모델, 룰기반 탐지 결과
  - 유저 신고 이력
  - 교전 시뮬레이션 결과 (시각화·지표)
- 종합 보고서 생성 → 운영팀 제재 판단 보조

**구현 내용**:
- **교전 단위 시뮬레이션 재구성**
  - `event_type` 기반 이벤트 분류: `1`=fire, `2`=hit, `3`=kill
  - `event_src_player_id` (공격자)와 `event_trg_player_id` (피해자) 기반 교전 추적
  - 각 틱(`tick`)마다 플레이어 위치(`X`, `Y`, `Z`), 조준 각도(`yaw`, `pitch`), 체력(`health`), 무기 정보 추적
  - `processData()` 함수에서 CSV 파싱하여 `positions` 배열과 `events` 배열 생성

- **정상적인 플레이 vs 비정상 입력/조준 패턴 판단**
  - EAC 탐지 패턴: aimbotLSTM, highCritRate, highHitRate, massiveReports 등
  - NCGuard 탐지: NCGuard 패턴 탐지 여부
  - 사내 에임봇 탐지: 사내 에임봇 탐지 모델 결과 + 킬별 에임 궤적 시각화(±30틱)
  - 룰기반 탐지: respawnHack, timeEnergyHack, cooldownIgnoreHack, rangeHack, movementHack, installHack

- **물리적으로 설명 가능한 결과 판단**
  - 무기 사거리 검증: `calculateEngagementDistance()` 함수로 교전 거리 계산
  - 각도/위치 관계 검증: 3D 좌표 기반 플레이어 간 거리 및 각도 계산
  - 킬 이벤트 유효성 검증: 무기 유효 사거리 내 여부 확인

#### ② 제재 후: CS/항의 대응 단계

**목적**: "왜 이 플레이어를 제재했는지"에 대한 설명 자료 제공

**활용 주체**: CS 팀 (이의 제기 대응)

**주요 기능**:
- 제재된 매치의 시뮬레이션 데이터 및 탐지 내역 조회
- 제재 시 활용된 근거 자료 재확인
- 보고서 다운로드/공유 → CS 팀이 항의나 이의 제기에 대응

**제공 내용**:
- 제재 판단 과정에서 검토한 교전: `generateReport()` 함수로 생성된 보고서, 3D 시뮬레이션에서 해당 교전 시점으로 이동 가능
- 해당 교전에서 확인된 비정상 정황: 보고서의 "상세 증거" 섹션, EAC/NCGuard/사내 ML/룰기반 탐지 내역, 킬별 에임 궤적 시각화 이미지
- 판단에 활용된 데이터 및 시각적 근거: 플레이어 정보, 매치 정보, 교전 통계, 킬 이벤트 상세, 에임 궤적 분석 이미지

#### 최종 목표

👉 **"이 교전에서 왜 이 플레이어를 제재했는지 / 혹은 왜 제재하지 않았는지"를 운영 관점에서 재현·설명 가능하게 만드는 것**

### 1.2 "제재 판단 / 이의 제기 대응" 활용 범위에 대한 명확한 전제

#### ① 제재 판단 전제

**본 툴은 단일 신호만으로 제재를 결정하는 자동 판정 도구가 아님**

다음 정보를 종합적으로 검토하여 운영 판단을 보조하는 것을 전제로 함:

1. **EAC, NCGUARD 등 안티치트 프로그램 탐지 결과**
   - 분석 보고서 데이터 테이블에서 `match_id`와 `account_id`로 조인
   - `eacDetection.detected`, `ncguardDetection.detected` 필드

2. **사내 에임봇 ML 모델 탐지 결과**
   - `internalAimbotDetection.detected` 필드
   - 킬별 에임 궤적 시각화 자료

3. **룰 기반 비정상 패턴 탐지 결과**
   - `ruleBasedDetection.patterns` 객체의 각 패턴 플래그

4. **유저 신고 이력**
   - `userReports.reports` 배열 (신고자, 사유, 시간 등)

5. **교전 시뮬레이션 결과 (시각화·지표)**
   - 3D 시뮬레이션: 플레이어 위치, 킬 이벤트, 이동 경로
   - 에임 궤적 분석: 킬별 ±30틱 범위의 yaw/pitch 변화량
   - Per-Step Distances 차트: 정상 유저와 비교

👉 **시뮬레이션 결과는 '결정 근거 중 하나'로 활용됨**

#### ② 이의 제기 대응 전제

**이의 제기 대응 시, 본 툴은 다음을 제공:**

1. **제재 판단 과정에서 검토한 교전**
   - `generateReport()` 함수로 생성된 보고서
   - 3D 시뮬레이션에서 해당 교전 시점으로 이동 가능 (`goToKill()`, `goToEvent()` 함수)

2. **해당 교전에서 확인된 비정상 정황**
   - 보고서의 "상세 증거" 섹션
   - EAC/NCGuard/사내 ML/룰기반 탐지 내역
   - 킬별 에임 궤적 시각화 이미지

3. **판단에 활용된 데이터 및 시각적 근거**
   - 플레이어 정보, 매치 정보, 교전 통계
   - 킬 이벤트 상세 (시간, 공격자, 피해자, 사용무기, 헤드샷 여부)
   - 에임 궤적 분석 이미지

👉 **CS/운영팀이 의사결정을 설명하기 위한 내부 근거 정리 수단임**

👉 **외부 유저에게 직접 제공되는 리플레이/영상 도구가 아님**

#### "전제"의 의미

본 문서에서 사용하는 전제란 다음을 의미합니다:

1. **본 툴이 무엇을 할 수 있고 / 무엇을 하지 않는지**
   - 할 수 있는 것: 교전 데이터 재현·시각화, 판단에 필요한 정황 정보 제공, 이상 패턴 및 이벤트 포인트 빠른 탐색 지원
   - 하지 않는 것: 자동 제재, 자동 판정

2. **판단 책임이 툴이 아닌 운영 주체에 있음**
   - 최종 제재 판단 책임: 운영팀
   - 툴의 역할: 판단 보조 자료 제공

3. **데이터 해석 결과는 절대 기준 + 해석 기준이 혼합된 형태임**
   - 절대 기준: EAC/NCGuard 탐지 내역
   - 해석 기준: 사내 ML 모델, 룰기반 탐지, 유저 신고, 교전 시뮬레이션 결과

👉 **즉, 전제는 툴의 책임 범위와 한계를 명확히 정의하기 위한 선언이다**

### 1.3 M1 단계에서 반드시 포함되어야 하는 범위 / 제외 가능 범위

#### M1 단계에서 반드시 포함되어야 하는 범위 (현재 구현 완료)

1. **교전 단위 시뮬레이션**
   - ✅ `processData()` 함수: CSV 파싱 및 `positions`/`events` 배열 생성
   - ✅ 틱별 플레이어 위치, 조준 각도, 체력 추적
   - ✅ 이벤트 타입별 분류 (fire/hit/kill)

2. **플레이어 위치 / 조준(pitch, yaw) / 이벤트(fire, hit, kill) 재생**
   - ✅ `updateSimulation()` 함수: 틱별 시뮬레이션 업데이트
   - ✅ `renderScene()` 함수: Three.js 기반 3D 렌더링
   - ✅ 플레이어 메시, 킬 이벤트 마커, 이동 경로 시각화

3. **이벤트 타임라인 기반 탐색**
   - ✅ `goToKill()` 함수: 킬 이벤트로 이동
   - ✅ `goToEvent()` 함수: 특정 이벤트로 이동
   - ✅ 킬 이벤트 선택 드롭다운 (`kill-select`)

4. **교전 내 주요 지표 및 이상 징후 시각화**
   - ✅ `generateReport()` 함수: 플레이어별 보고서 생성
   - ✅ 에임 궤적 분석: 킬별 ±30틱 범위 시각화
   - ✅ Per-Step Distances 차트: 정상 유저와 비교

5. **운영/CS 판단을 위한 UI 인터랙션**
   - ✅ 플레이어 목록에서 플레이어 클릭 → 보고서 생성
   - ✅ 보고서 다운로드 기능
   - ✅ 3D 시뮬레이션과 보고서 간 연동

#### M1 단계에서 제외 가능한 범위

1. **맵 이미지 위 실제 지형 투영 기능**
   - ❌ `loadMapImageFromPath()`, `renderMapImage()` 함수는 구현되어 있으나, 실제 맵 이미지 파일은 제공되지 않음
   - ✅ 대신 좌표 기반 시뮬레이션 및 상대 위치 표현은 포함됨
     - `mapBounds` 계산: 플레이어 위치 기반 경계 계산
     - 플레이어 간 거리 계산: `calculateEngagementDistance()` 함수
     - 그리드 및 구역 표시: `setupMapBounds()` 함수

---

## 2. 운영/정책 관점

### 2.1 시뮬레이션 결과의 활용 주체(운영 내부 기준)

#### 운영팀

**활용 시나리오**:
- 제재 검토 시 교전 시뮬레이션 및 보고서 조회
- 매치 ID와 계정 ID로 조인하여 데이터 조회
- 플레이어 목록에서 의심 플레이어 선택 → 보고서에서 탐지 내역 확인 → 3D 시뮬레이션에서 해당 교전 시점 확인

**주요 목적**: 제재 전 의심 매치 분석, "왜 이 유저를 제재해야 하는가"에 대한 판단 근거 확인

#### CS 팀

**활용 시나리오**:
- 이의 제기 대응 시 보고서 다운로드/공유
- 내부 검토용 설명 자료로 활용
- 제재 판단 과정에서 검토한 교전 확인 → 해당 교전에서 확인된 비정상 정황 설명 → 판단에 활용된 데이터 및 시각적 근거 제공

**주요 목적**: 제재 후 CS/항의 대응, "왜 이 플레이어를 제재했는지"에 대한 설명 자료 제공

#### 내부 이슈 리뷰 및 판단 기준 정렬

- 보고서 구조를 통한 일관된 판단 기준 적용
- 탐지 내역 종합 검토

### 2.2 판단 책임 주체 및 툴의 역할 범위 (자동 판단 여부 아님에 대한 전제 포함)

#### 판단 책임 주체

**최종 제재 판단 책임은 운영팀에 있음**

- 툴은 판단 보조 자료만 제공
- 최종 결정은 운영팀이 수동으로 수행

#### 툴의 역할 범위

**교전 데이터를 재현·시각화**
- 3D 시뮬레이션: 플레이어 위치, 킬 이벤트, 이동 경로
- 에임 궤적 분석: 킬별 ±30틱 범위의 yaw/pitch 변화량
- Per-Step Distances 차트: 정상 유저와 비교

**판단에 필요한 정황 정보 제공**
- 플레이어 정보, 매치 정보, 교전 통계
- 탐지 내역 (EAC, NCGuard, 사내 ML, 룰기반)
- 유저 신고 이력

**이상 패턴 및 이벤트 포인트 빠른 탐색 지원**
- 킬 이벤트 선택 드롭다운
- `goToKill()`, `goToEvent()` 함수로 해당 시점으로 이동
- 플레이어 목록에서 K/D 비율 필터링

👉 **자동 제재 / 자동 판정 도구가 아님을 명확히 전제로 함**

### 2.3 공통 기준으로 활용하고자 하는 방향성(절대 기준 vs 해석 기준)

| 구분 | 기준 성격 | 현재 구현 상태 | 실제 서비스 적용 |
|------|----------|---------------|----------------|
| **EAC / NCGUARD 탐지 내역** | 절대적 기준 | Mock 데이터 (`generateMockData()`) | 분석 보고서 데이터 테이블에서 조인 |
| **사내 ML 모델 탐지** | 보조적 판단 자료 | Mock 데이터 + 에임 궤적 시각화 | 분석 보고서 데이터 테이블에서 조인 |
| **룰 기반 패턴 탐지** | 보조적 판단 자료 | Mock 데이터 | 분석 보고서 데이터 테이블에서 조인 |
| **유저 신고 내역** | 참고 자료 | Mock 데이터 | 분석 보고서 데이터 테이블에서 조인 |
| **교전 시뮬레이션 결과** | 판단 근거 설명용 | 실제 데이터 (시뮬레이션 데이터 테이블) | 시뮬레이션 데이터 테이블에서 조인 |

**현재 구현**
- 모든 탐지 내역은 Mock 데이터 사용
- 시뮬레이션 데이터만 실제 데이터 사용

**실제 서비스 적용 시**
- 시뮬레이션 데이터 테이블과 분석 보고서 데이터 테이블을 `match_id`와 `account_id`로 조인
- Mock 데이터 대신 실제 탐지 결과 사용

**기준 성격 설명**
- **절대 기준**: EAC/NCGuard 탐지 내역 - 객관적이고 명확한 탐지 결과
- **해석 기준**: 사내 ML 모델, 룰기반 탐지, 유저 신고, 교전 시뮬레이션 결과 - 운영팀이 종합적으로 판단해야 하는 자료

---

## 3. 데이터/환경 전제

### 3.1 1월 이후 제공 예정인 데이터의 범위

#### 기본 전제 - 에임 로그 스키마 (필수)

**현재 `index_new_report.html`에서 사용 중인 필드들**:

**필수 필드**:
- `tick`: 게임 틱 번호 (INTEGER)
- `game_time`: 게임 시간 초 (FLOAT)
- `match_id`: 매치 고유 ID (STRING) - 조인 키
- `player_id`: 플레이어 계정 ID (STRING) - 조인 키
- `player_name`: 플레이어 이름 (STRING)
- `X`, `Y`, `Z`: 플레이어 3D 좌표 (FLOAT)
- `health`: 플레이어 체력 0-100 (FLOAT)

**선택적 필드**:
- `yaw`: 수평 조준 각도 (FLOAT, nullable)
- `pitch`: 수직 조준 각도 (FLOAT, nullable)
- `equipped_weapon_id`: 장착 무기 ID (INTEGER, nullable)

**이벤트 필드 (이벤트 발생 시점에만 존재)**:
- `event_type`: 이벤트 타입 1=fire, 2=hit, 3=kill (INTEGER, nullable)
- `event_src_player_id`: 공격자 플레이어 ID (STRING, nullable)
- `event_trg_player_id`: 피해자 플레이어 ID (STRING, nullable)
- `event_src_id`: 이벤트 소스 ID (무기 ID 등) (INTEGER, nullable)
- `head_shot_yn`: 헤드샷 여부 0/1 (INTEGER, nullable)

**포맷은 거의 동일하게 유지, 누락 여부만 확인 필요**

#### 추가 예정 - 분석 보고서 데이터 테이블 (새로 추가)

**1. 유저 신고 데이터**
- 신고자 계정 ID, 신고 사유 (1-5), 신고 시간, 신고 날짜

**2. EAC 탐지 내역**
- Aimbot LSTM, high_crit_rate, high_hit_rate, massive_reports, recursive_massive_reports, 동일 기기 다계정, 하드웨어 밴, DMA 탐지

**3. NCGUARD 탐지 내역**
- NCGuard 패턴 탐지 결과

**4. 사내 ML 모델 탐지 결과**
- 사내 에임봇 탐지 모델 결과
- 킬별 에임 궤적 데이터 (선택적)

**5. 룰 기반 비정상 패턴 탐지 결과**
- 리스폰 핵, 타임에너지 핵, 쿨타임 무시 핵, 사거리 핵, 이동 핵, 설치 핵

**6. 매치 정보**
- 게임 타입 (AI매치/일반매치/이벤트매치/커스텀매치), 팀 타입 (솔로/듀오/트리오/스쿼드), 맵 이름, 매치 시작/종료 시간

**7. 플레이어 정보**
- 계정 ID, 유저명, 여행자 정보 (1-15), OS 정보, 입력 장치

**8. 교전 통계**
- 매치 내 순위, 생존시간, K/D/A, 총 데미지, 명중률

**9. 아이템/스킬 정보**
- 아이템 구매 내역, 스킬 강화 정보

※ **운영팀 의견 수렴 이후 최종 범위 확정 필요**

### 3.2 데이터 정확도에 대한 전제

#### 개별 로그 데이터의 정확도 자체는 신뢰 가능

**시뮬레이션 데이터**
- 포맷은 거의 동일하게 유지
- 누락 여부만 확인 필요 (특정 틱/이벤트 누락 가능)

**분석 보고서 데이터**
- 1월 이후 제공 예정
- 제공 범위와 시점에 따라 활용 가능 범위 변동

👉 **"정확하지 않다"가 아니라 "활용 범위가 단계적으로 확장된다"는 관점**

#### 데이터 누락 처리

**시뮬레이션 데이터**
- 특정 틱 누락: 이전 틱 데이터로 보간 가능
- 이벤트 누락: 해당 이벤트가 기록되지 않음 (복구 불가)

**분석 보고서 데이터**
- 탐지 내역 누락: 해당 탐지 결과가 없는 것으로 처리
- 유저 신고 누락: 신고 내역이 없는 것으로 처리

### 3.3 활용 가능 조건

1. **운영팀 정책 논의 완료**
   - 탐지 내역 종합 판단 기준 확정
   - 보고서 구조 및 표시 항목 확정

2. **데이터 적재 안정성 확보**
   - 시뮬레이션 데이터 테이블과 분석 보고서 데이터 테이블 간 조인 안정성
   - 데이터 누락 최소화

3. **이벤트 타입 / 필드 정의 변경 시 사전 공유**
   - `event_type` 값 변경
   - 새로운 필드 추가
   - 필드명 변경

4. **그 외 별도의 특수 조건은 없음**

### 3.4 PoC와 실제 서비스 적용 간의 차이에 대한 전제 사항

| 구분 | PoC (현재) | 실제 서비스 |
|------|-----------|------------|
| **데이터 제공 방식** | 파일 업로드 (`loadCSVFile()` 함수) | 조회 기반 (API/스토리지) |
| **대상 데이터** | 제한적 샘플 (CSV 파일) | 실 운영 데이터 |
| **탐지 내역** | Mock 데이터 (`generateMockData()` 함수) | 실제 데이터 (분석 보고서 데이터 테이블) |
| **사용 주체** | 분석/기획 중심 | 운영/CS 중심 |
| **목적** | 구조 검증 | 실무 활용 |
| **조회 방식** | 파일 선택 → 로드 | `match_id`와 `account_id`로 조회 |
| **데이터 조인** | CSV 내 필드 또는 Mock 데이터 | 시뮬레이션 데이터 테이블 + 분석 보고서 데이터 테이블 조인 |

**PoC (현재 구현)**
- 파일 업로드 방식으로 CSV 데이터를 로드
- Mock 데이터를 사용하여 탐지 결과 생성
- 구조 검증 및 기능 확인이 주 목적

**실제 서비스**
- API/스토리지에서 `match_id`와 `account_id`로 조회
- 분석 보고서 테이블에서 실제 데이터를 조인하여 사용
- 운영팀/CS 팀의 실무 활용이 주 목적

※ **실제 구현 방식은 개발팀/플랫폼 논의 후 확정**

---

## 부록

### 주요 함수 목록

- `processData()`: CSV 파싱 및 데이터 구조화
- `updateSimulation()`: 틱별 시뮬레이션 업데이트
- `renderScene()`: Three.js 기반 3D 렌더링
- `goToKill()`: 킬 이벤트로 이동
- `goToEvent()`: 특정 이벤트로 이동
- `generateReport()`: 플레이어별 보고서 생성
- `generateMockData()`: Mock 데이터 생성 (PoC용)
- `calculateEngagementDistance()`: 교전 거리 계산

### 데이터 구조

**positions 배열**:
```javascript
{
  tick: INTEGER,
  game_time: FLOAT,
  players: [
    {
      name: STRING,
      team: STRING,
      position: [FLOAT, FLOAT, FLOAT],
      health: FLOAT,
      yaw: FLOAT,
      pitch: FLOAT,
      weapon: INTEGER
    }
  ]
}
```

**events 배열**:
```javascript
{
  tick: INTEGER,
  game_time: FLOAT,
  event_type: STRING, // 'fire', 'hit', 'kill'
  attacker: {
    name: STRING,
    team: STRING,
    position: [FLOAT, FLOAT, FLOAT],
    weapon: INTEGER
  },
  victim: {
    name: STRING,
    team: STRING,
    position: [FLOAT, FLOAT, FLOAT]
  },
  weapon: INTEGER,
  headshot: BOOLEAN
}
```

---

**문서 버전**: 2.0  
**최종 업데이트**: 2025-01-13  
**기반 구현**: `index_new_report.html`
